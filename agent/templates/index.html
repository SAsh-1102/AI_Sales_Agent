<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Sales Agent</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; display:flex; justify-content:center; padding:30px; }
    .container { width:420px; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); overflow:hidden; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#0b8456; color:#fff; }
    .badge { padding:6px 10px; border-radius:18px; font-weight:700; }
    .stage-cold { background:#9aa6a0; color:#fff; }
    .stage-warm { background:#ffb347; color:#000; }
    .stage-hot  { background:#ff6b6b; color:#fff; }
    .stage-closed{ background:#4caf50; color:#fff; }
    .chat { padding:12px; height:420px; overflow:auto; background:#f9fafb; }
    .message { max-width:80%; margin:8px 0; padding:10px 12px; border-radius:12px; line-height:1.4; }
    .user { margin-left:auto; background:#0b8456; color:#fff; border-bottom-right-radius:2px; }
    .bot  { margin-right:auto; background:#e9ecef; color:#000; border-bottom-left-radius:2px; }
    .footer { display:flex; border-top:1px solid #eee; }
    input { flex:1; padding:12px; border:none; outline:none; }
    button { background:#0b8456; color:#fff; border:none; padding:12px 18px; cursor:pointer; }
    .meta { font-size:12px; color:#333; margin-left:8px; }
    .debug { font-size:12px; padding:8px 12px; color:#444; border-top:1px dashed #eee; background:#fafafa; max-height:120px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>AI Sales Agent</div>
      <div>
        <span id="leadBadge" class="badge stage-cold">Lead: Cold</span>
        <span id="emoLabel" class="meta" style="margin-left:10px">Emotion: neutral</span>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="footer">
      <input id="input" type="text" placeholder="Type a message..." />
      <button id="send">Send</button>
      <button id="mic">ðŸŽ¤</button>
    </div>

    <div id="debug" class="debug" style="display:none;"></div>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const micBtn = document.getElementById('mic');
    const leadBadge = document.getElementById('leadBadge');
    const emoLabel = document.getElementById('emoLabel');
    const debugEl = document.getElementById('debug');

    // session id persists across reloads
    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = 'sess_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('sessionId', sessionId);
    }

    function addMessage(who, text) {
      const d = document.createElement('div');
      d.className = 'message ' + (who === 'user' ? 'user' : 'bot');
      d.textContent = text;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setLeadStage(stage) {
      leadBadge.textContent = 'Lead: ' + stage;
      leadBadge.className = 'badge ' +
        (stage === 'cold' ? 'stage-cold' : stage === 'warm' ? 'stage-warm' : stage === 'hot' ? 'stage-hot' : 'stage-closed');
    }

    function setEmotion(e) {
      emoLabel.textContent = 'Emotion: ' + e;
    }

    async function sendMessageFromUI(text) {
      addMessage('user', text);
      // typing indicator
      addMessage('bot', 'Sales Agent is typing...');
      try {
        const res = await fetch("{% url 'chat_api' %}", {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ session_id: sessionId, message: text })
        });
        const data = await res.json();

        // remove last typing bubble
        const msgs = chatEl.querySelectorAll('.message.bot');
        if (msgs.length) {
          const last = msgs[msgs.length-1];
          if (last.textContent === 'Sales Agent is typing...') last.remove();
        }

        addMessage('bot', data.reply);
        setLeadStage(data.lead_stage);
        setEmotion(data.emotion);

        // debug info
        debugEl.textContent = JSON.stringify(data.memory, null, 2);

        // ---- TTS (bot reply) ----
        const utterance = new SpeechSynthesisUtterance(data.reply);
        utterance.lang = "en-US";
        utterance.pitch = 1;
        utterance.rate = 1;
        speechSynthesis.speak(utterance);

      } catch (err) {
        console.error(err);
        addMessage('bot', 'Error contacting server.');
      }
    }

    sendBtn.addEventListener('click', () => {
      const val = inputEl.value.trim();
      if (!val) return;
      sendMessageFromUI(val);
      inputEl.value = '';
    });

    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // ---- STT (mic button) ----
    micBtn.addEventListener('click', () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech Recognition not supported in this browser. Try Chrome.");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessageFromUI(transcript);
      };

      recognition.onerror = (event) => {
        console.error("STT error:", event.error);
        addMessage('bot', 'ðŸŽ¤ Speech recognition error: ' + event.error);
      };
    });

    // welcome msg
    window.addEventListener('load', () => {
      addMessage('bot', "ðŸ¤– Welcome! I'm your AI sales assistant. Type or speak your question.");
      const utterance = new SpeechSynthesisUtterance("Welcome! I'm your AI sales assistant. You can type or speak your question.");
      speechSynthesis.speak(utterance);
    });
  </script>
</body>
</html>
