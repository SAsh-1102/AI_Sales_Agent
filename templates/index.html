<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Sales Agent</title>
<style>
  body { font-family:'Segoe UI',Tahoma,sans-serif; background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
  .container { width:430px; height:650px; background:#fff; border-radius:20px; box-shadow:0 12px 30px rgba(0,0,0,0.25); display:flex; flex-direction:column; overflow:hidden; position:relative; }
  .header { background:linear-gradient(135deg,#0b8456,#11998e); color:#fff; padding:18px; display:flex; justify-content:space-between; align-items:center; font-weight:600; font-size:18px; letter-spacing:0.5px; }
  .badge { padding:6px 12px; border-radius:20px; font-size:13px; font-weight:600; }
  .stage-cold { background:#9aa6a0; color:#fff; }
  .stage-warm { background:#ffb347; color:#000; }
  .stage-hot { background:#ff6b6b; color:#fff; }
  .stage-closed { background:#4caf50; color:#fff; }
  .chat { flex:1; padding:16px; overflow-y:auto; background:#f8fafc; display:flex; flex-direction:column; }
  .message { max-width:75%; margin:6px 0; padding:12px 16px; border-radius:18px; line-height:1.4; font-size:14px; position:relative; animation:fadeIn 0.3s ease-in-out; }
  @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
  .user { margin-left:auto; background:linear-gradient(135deg,#0b8456,#11998e); color:#fff; border-bottom-right-radius:4px; }
  .bot { margin-right:auto; background:#e9ecef; color:#000; border-bottom-left-radius:4px; }
  .footer { display:flex; border-top:1px solid #eee; padding:10px; background:#fff; }
  input { flex:1; padding:12px; border:1px solid #ddd; border-radius:25px; outline:none; font-size:14px; transition:all 0.2s ease; }
  input:focus { border-color:#0b8456; box-shadow:0 0 5px rgba(11,132,86,0.3); }
  button { margin-left:8px; background:linear-gradient(135deg,#0b8456,#11998e); color:#fff; border:none; padding:12px 16px; border-radius:50%; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
  button:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
  .mic { background:linear-gradient(135deg,#ff416c,#ff4b2b); }
  .meta-bar { font-size:12px; padding:6px 14px; color:#333; background:#f1f5f9; display:flex; justify-content:space-between; align-items:center; }
  .debug { font-size:11px; padding:8px 12px; color:#444; border-top:1px dashed #eee; background:#fafafa; max-height:110px; overflow:auto; white-space:pre-wrap; font-family:monospace; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>🤖 AI Sales Agent</div>
    <span id="leadBadge" class="badge stage-cold">Lead: Cold</span>
  </div>

  <div class="meta-bar">
    <span id="emoLabel">Emotion: neutral</span>
    <span>Session active</span>
  </div>

  <div id="chat" class="chat"></div>

  <div class="footer">
    <input id="input" type="text" placeholder="Type a message..." />
    <button id="send">➤</button>
    <button id="mic" class="mic">🎙</button>
  </div>

  <div id="debug" class="debug"></div>
</div>

<script>
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const micBtn = document.getElementById('mic');
const leadBadge = document.getElementById('leadBadge');
const emoLabel = document.getElementById('emoLabel');
const debugEl = document.getElementById('debug');

let mediaRecorder, chunks=[], isRecording=false, recordedMime='';
let sessionId = localStorage.getItem('sessionId') || (()=>{ const sid='sess_'+Math.random().toString(36).slice(2,10); localStorage.setItem('sessionId',sid); return sid; })();

function addMessage(who,text){ const d=document.createElement('div'); d.className='message '+(who==='user'?'user':'bot'); d.textContent=text; chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight; }

function setLeadStage(stage){ leadBadge.textContent='Lead: '+stage; leadBadge.className='badge '+(stage==='cold'?'stage-cold':stage==='warm'?'stage-warm':stage==='hot'?'stage-hot':'stage-closed'); }

function setEmotion(e){ emoLabel.textContent='Emotion: '+e; }

async function sendMessageFromUI(text){
  addMessage('user',text);
  addMessage('bot','⌛ Sales Agent is typing...');
  try{
    const res=await fetch('/agent/chat/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId,message:text})});
    const data=await res.json(); handleBotResponse(data);
  }catch(err){ console.error(err); addMessage('bot','❌ Error contacting server.'); }
}

async function sendAudio(blob,filename){
  addMessage('user',"🎤 (voice message)");
  addMessage('bot','⌛ Sales Agent is typing...');
  let formData=new FormData(); formData.append("audio",blob,filename); formData.append("session_id",sessionId);
  try{ const res=await fetch('/agent/voice/',{method:"POST",body:formData}); const data=await res.json(); handleBotResponse(data); } 
  catch(err){ console.error(err); addMessage('bot','❌ Error contacting server.'); }
}

function handleBotResponse(data){
  const msgs=chatEl.querySelectorAll('.message.bot'); if(msgs.length && msgs[msgs.length-1].textContent.includes('typing')) msgs[msgs.length-1].remove();
  if(data.error){ addMessage('bot',"⚠️ "+data.error); debugEl.textContent=JSON.stringify(data,null,2); return; }
  addMessage('bot',data.reply||"(no reply)");
  setLeadStage(data.lead_stage||"cold"); setEmotion(data.emotion||"neutral");
  debugEl.textContent=JSON.stringify(data.memory||data,null,2);
  if(data.audio){ try{ const audio=new Audio("data:audio/mp3;base64,"+data.audio); audio.play().catch(e=>console.warn("Audio play blocked:",e)); } catch(e){console.error("Audio playback error:",e);} }
}

sendBtn.addEventListener('click',()=>{ const val=inputEl.value.trim(); if(!val) return; sendMessageFromUI(val); inputEl.value=''; });
inputEl.addEventListener('keypress',e=>{ if(e.key==='Enter') sendBtn.click(); });

micBtn.addEventListener('click',async ()=>{
  if(!isRecording){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      const candidates=['audio/webm;codecs=opus','audio/ogg;codecs=opus','audio/webm','audio/ogg'];
      let mime=''; for(const c of candidates){ if(MediaRecorder.isTypeSupported(c)){ mime=c; break; } }
      recordedMime=mime||'audio/webm';
      mediaRecorder=new MediaRecorder(stream,{mimeType:recordedMime});
      chunks=[];
      mediaRecorder.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop=()=>{
        const blob=new Blob(chunks,{type:recordedMime});
        const ext=(recordedMime.includes('ogg')?'.ogg':recordedMime.includes('webm')?'.webm':'.wav');
        sendAudio(blob,'voice'+ext);
      };
      mediaRecorder.start(); isRecording=true; micBtn.textContent="⏹";
      setTimeout(()=>{ if(isRecording){ mediaRecorder.stop(); isRecording=false; micBtn.textContent="🎙"; } },10000);
    }catch(err){ console.error("Mic error:",err); addMessage('bot','❌ Microphone not accessible.'); }
  } else { mediaRecorder.stop(); isRecording=false; micBtn.textContent="🎙"; }
});

window.addEventListener('load',()=>{ addMessage('bot',"👋 Welcome! I'm your AI sales assistant. Type or speak to get started."); debugEl.textContent="Debug output will appear here."; });
</script>
</body>
</html>
