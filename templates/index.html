<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Sales Agent</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; display:flex; justify-content:center; padding:30px; }
    .container { width:420px; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); overflow:hidden; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#0b8456; color:#fff; }
    .badge { padding:6px 10px; border-radius:18px; font-weight:700; }
    .stage-cold { background:#9aa6a0; color:#fff; }
    .stage-warm { background:#ffb347; color:#000; }
    .stage-hot  { background:#ff6b6b; color:#fff; }
    .stage-closed{ background:#4caf50; color:#fff; }
    .chat { padding:12px; height:420px; overflow:auto; background:#f9fafb; }
    .message { max-width:80%; margin:8px 0; padding:10px 12px; border-radius:12px; line-height:1.4; }
    .user { margin-left:auto; background:#0b8456; color:#fff; border-bottom-right-radius:2px; }
    .bot  { margin-right:auto; background:#e9ecef; color:#000; border-bottom-left-radius:2px; }
    .footer { display:flex; border-top:1px solid #eee; flex-wrap: wrap; gap: 5px; }
    input { flex:1; padding:12px; border:none; outline:none; min-width: 150px; }
    button { background:#0b8456; color:#fff; border:none; padding:12px 18px; cursor:pointer; }
    button:disabled { background: #888; cursor: not-allowed; }
    .meta { font-size:12px; color:#fff; margin-left:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>AI Sales Agent</div>
      <div>
        <span id="leadBadge" class="badge stage-cold">Lead: Cold</span>
        <span id="emoLabel" class="meta">Emotion: neutral</span>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="footer">
      <input id="input" type="text" placeholder="Type a message..." />
      <button id="send">Send</button>
      <button id="micStart">ðŸŽ¤ Start</button>
      <button id="micStop" disabled>ðŸ›‘ Stop</button>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const micStartBtn = document.getElementById('micStart');
    const micStopBtn = document.getElementById('micStop');
    const leadBadge = document.getElementById('leadBadge');
    const emoLabel = document.getElementById('emoLabel');

    // session id persists across reloads
    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = 'sess_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('sessionId', sessionId);
    }

    // Global SpeechRecognition object
    let recognition;

    function addMessage(who, text) {
      const d = document.createElement('div');
      d.className = 'message ' + (who === 'user' ? 'user' : 'bot');
      d.textContent = text;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setLeadStage(stage) {
      leadBadge.textContent = 'Lead: ' + stage;
      leadBadge.className = 'badge ' +
        (stage === 'cold' ? 'stage-cold' : stage === 'warm' ? 'stage-warm' : stage === 'hot' ? 'stage-hot' : 'stage-closed');
    }

    function setEmotion(e) {
      emoLabel.textContent = 'Emotion: ' + e;
    }

    async function sendMessageFromUI(text) {
      if (!text) return;

      addMessage('user', text);

      // typing indicator
      const typingEl = document.createElement('div');
      typingEl.className = 'message bot';
      typingEl.textContent = 'Sales Agent is typing...';
      chatEl.appendChild(typingEl);
      chatEl.scrollTop = chatEl.scrollHeight;

      try {
        const res = await fetch("{% url 'chat_api' %}", {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ session_id: sessionId, message: text })
        });
        const data = await res.json();

        // remove typing bubble
        typingEl.remove();

        // display bot reply
        addMessage('bot', data.reply);

        // update lead and emotion
        setLeadStage(data.lead_stage);
        setEmotion(data.emotion);

        // TTS
        const utterance = new SpeechSynthesisUtterance(data.reply);
        utterance.lang = "en-US";
        utterance.pitch = 1;
        utterance.rate = 1;
        speechSynthesis.speak(utterance);

      } catch (err) {
        console.error(err);
        typingEl.remove();
        addMessage('bot', 'Error contacting server.');
      }
    }

    sendBtn.addEventListener('click', () => {
      const val = inputEl.value.trim();
      sendMessageFromUI(val);
      inputEl.value = '';
    });

    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // ---- STT: Start button ----
    micStartBtn.addEventListener('click', () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech Recognition not supported in this browser. Try Chrome.");
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      micStartBtn.disabled = true;
      micStopBtn.disabled = false;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessageFromUI(transcript);
      };

      recognition.onerror = (event) => {
        console.error("STT error:", event.error);
        addMessage('bot', 'ðŸŽ¤ Speech recognition error: ' + event.error);
        micStartBtn.disabled = false;
        micStopBtn.disabled = true;
      };

      recognition.onend = () => {
        // automatically reset buttons when recognition ends
        micStartBtn.disabled = false;
        micStopBtn.disabled = true;
      };
    });

    // ---- STT: Stop button ----
    micStopBtn.addEventListener('click', () => {
      if (recognition) {
        recognition.stop();
        micStartBtn.disabled = false;
        micStopBtn.disabled = true;
      }
    });

    // ---- Page load: fetch conversation history ----
    window.addEventListener('load', async () => {
      try {
        const res = await fetch("{% url 'chat_api' %}", {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ session_id: sessionId, message: "" })
        });
        const data = await res.json();

        if (data.history && data.history.length) {
          data.history.forEach(msg => addMessage(msg.sender, msg.message));
        }

        setLeadStage(data.lead_stage || 'cold');
        setEmotion(data.emotion || 'neutral');

        if (!data.history.length) {
          addMessage('bot', "ðŸ¤– Welcome! I'm your AI sales assistant. Type or speak your question.");
          const utterance = new SpeechSynthesisUtterance("Welcome! I'm your AI sales assistant. You can type or speak your question.");
          speechSynthesis.speak(utterance);
        }

      } catch(err) {
        console.error("Error fetching history:", err);
      }
    });
  </script>
</body>
</html>
